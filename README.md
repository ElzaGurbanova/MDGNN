
# MDGNN: Graph Neural Network based Data Flow Analysis for JS Vulnerability Detection (Path Traversal & Command Injection)

This repository contains:

* **Dataset** of JavaScript projects and single-file samples labeled for
  **Path Traversal (PT)** and **Command Injection (CI)**
* **GraphJS MDGs** (`nodes.csv`, `rels.csv`, `graph_stats.json`) for each sample
* **Indexes** (`index.csv`, `index_clean.csv`) describing labels/splits
* **Parser helper** to generate MDGs from `.js` files
* **Training script** (`train_multitask_rgcn.py`) for a multi-task R-GCN

---

## Repository Layout

```
.
├── Dataset_with_details/           # (optional) any notes, per-sample docs
├── Graph_files/                    # one folder per sample (has nodes.csv/rels.csv/graph_stats.json)
│   ├── ci_secure/ ...              # secure CI samples
│   ├── ci_vuln/ ...                # vulnerable CI samples
│   ├── pt_secure/ ...              # secure PT samples
│   └── pt_vuln/ ...                # vulnerable PT samples
├── JS_totals/                      # original JS sources (used to regenerate MDGs)
├── parser/                         # helper scripts for batch MDG generation
├── index.csv                       # main index (may contain absolute paths)
├── index_clean.csv                 # validated/cleaned index (preferred)
├── make_index_from_four_buckets_nosource.py  # builds index from the 4 bucket folders
├── train_multitask_rgcn.py         # training + 5-fold grouped CV
└── README.md
```

---

## Dataset Summary

### Command Injection (CWE-78)

| Source      | Vulnerable | Secure  | Notes                                                                                                        |
| ----------- | ---------- | ------- | ------------------------------------------------------------------------------------------------------------ |
| Secbench    | 87         | 39      | Added fix code of `command_exists`                                                                           |
| VulCan      | 47         | 20      | 2/20 TS in secure; 2/47 TS in vulnerable. Removed 44 duplicates.                                             |
| GitHub      | 6          | 72      | Mainly looked for spawn exec and execFile.                                                                   |
| Synthetic   | 30         | 40      | Each sample was crafted considering different application features.                                          |
| Snyk recent | 25         | 23      | After 2021; 10/23 TS in secure converted to JS. 23 “notes” files kept in vulnerable. 11/25 TS in vulnerable. |
| **Total**   | **195**    | **194** | 389                                                                                                          |

### Path Traversal (CWE-22)

| Source                              | Vulnerable | Non-vulnerable | Notes                                                                                                     |
| ----------------------------------- | ---------- | -------------- | --------------------------------------------------------------------------------------------------------- |
| Secbench                            | 117        | 19             | Kept packages with available fixes. Removed json/tests.                                                   |
| VulCan                              | 3          | 3              | Many overlap with Secbench; many sink labels were incorrect.                                              |
| Snyk recent samples                 | 22         | 19             | After 2021 only; removed 10/19 TS in secure & 9 notes files.                                              |
| GitHub                              | 18         | 129            | Selected projects already had partial checks; we hardened them with minimal changes to preserve behavior. |
| Synthetic samples generated by GPT5 | 22         | 13             | 40–100 LOC each                                                                                           |
| **Total**                           | **182**    | **183**        | **364**                                                                                                   |

**Per-sample files**: `Graph_files/.../<sample>/nodes.csv`, `rels.csv`, `graph_stats.json` (+ the original `.js` in `JS_totals/`).

---

## Sources Used (helpful but insufficient alone)

* SecBench.js:
  * CI: [https://github.com/cristianstaicu/SecBench.js/tree/main/command-injection](https://github.com/cristianstaicu/SecBench.js/tree/main/command-injection)
  * PT: [https://github.com/cristianstaicu/SecBench.js/tree/main/path-traversal](https://github.com/cristianstaicu/SecBench.js/tree/main/path-traversal)
* Vulcan Dataset:
  * PT (CWE-22): [https://github.com/formalsec/vulcan-dataset/tree/main/packages/CWE-22](https://github.com/formalsec/vulcan-dataset/tree/main/packages/CWE-22)
  * CI (CWE-77): [https://github.com/formalsec/vulcan-dataset/tree/main/packages/CWE-77](https://github.com/formalsec/vulcan-dataset/tree/main/packages/CWE-77)
* Snyk Database
	https://security.snyk.io/ 
* **GraphJS** (main tool for MDG generation):
  [https://github.com/formalsec/graphjs/tree/main](https://github.com/formalsec/graphjs/tree/main)

---

## Generating MDGs (GraphJS)

We used **GraphJS** to export **MDG** graphs as CSVs. From the GraphJS repo directory:

```bash
npm start -- -f path/to/file.js --csv -o /path/to/outdir
```

* Output directory will contain `nodes.csv`, `rels.csv`, and (if enabled) `graph_stats.json`.
* See GraphJS docs for details and research notes.

This repo also includes a simple bucket indexer:

```bash
python make_index_from_four_buckets_nosource.py \
  --root Graph_files \
  --out index.csv
```

> `index.csv` columns:
> `graph_dir,y_path,y_cmd,group,nodes,edges`
> where `y_path`/`y_cmd` ∈ {1,0,""} and `group` is the project identifier (keeps variants together).

---

## Training the Model (MDGNN)

### Model

* **Multi-task** R-GCN (3 layers, hidden 64 by default)
* **Two heads**: one for PT, one for CI
* Edge-type aware (AST/CFG/PDG/CG, etc.)
* Compact node features (type/subtype embeddings, tiny hashed identifier features, API flags, simple degrees)
* **Grouped 5-fold CV** by `group` (no cross-project leakage)
* **Label masking** per task (graphs may be labeled for only one task)

### Environment

* Python 3.9+ (3.11 OK)
* `torch`, `torch_geometric`, `pandas`, `numpy`, `scikit-learn`, `networkx`, `tqdm`, `pyyaml`

Install (Mac/venv example):

```bash
python3 -m venv .venv && source .venv/bin/activate
pip install --upgrade pip
pip install "torch>=2.4,<2.6" "torchvision>=0.19,<0.21" "torchaudio>=2.4,<2.6"
pip install torch-geometric pandas numpy scikit-learn networkx tqdm pyyaml
```

> **Hardware**
>
> * macOS (M-series): CPU training is stable; batch size 1–2 is fine for graphs ~1–3k nodes.


### Quick sanity run (small)

```bash
python3 train_multitask_rgcn.py \
  --index_csv index_clean.csv \
  --cache_dir cache_mdgs \
  --out_dir runs_try \
  --folds 2 --epochs 5 --batch_size 1 --hidden 32 --bases 4 --dropout 0.5
```

### Full run (recommended)

```bash
python3 train_multitask_rgcn.py \
  --index_csv index_clean.csv \
  --cache_dir cache_mdgs \
  --out_dir runs_rgcn \
  --folds 5 \
  --epochs 120 \
  --batch_size 1 \
  --hidden 64 \
  --bases 8 \
  --dropout 0.3
```

After training, per-fold metrics are in `runs_rgcn/results_foldK.json` and an aggregate is in `runs_rgcn/summary.json`.
Report **test** metrics per task: **PR-AUC (AP)** and **F1 at the validation-tuned threshold**.

---

## Reproducibility & Splits

* **Grouped CV**: all variants of a project (`group`) remain in the same fold.
* **Balanced folds** (recommended): ensure each fold has ≥1 positive for PT and CI.
* **Thresholding**: thresholds are tuned on **validation** only and applied unchanged to **test**.
* **Label masking**: graphs without a PT (or CI) label are excluded from that task’s loss/metrics.

---

## Regenerating Broken/Empty MDGs

If a sample is missing/has unreadable `nodes.csv`/`rels.csv`, re-export from the original `.js` sources using GraphJS:

```bash
npm start -- -f path/to/file.js --csv -o Graph_files/.../<group>
```

A helper (`regen_mdgs.py`) can map a list of bad graph dirs back to source projects and re-export multiple entry files per project (skipping tests, `node_modules`, etc.).

---

## Known Limitations

* Some upstream datasets contain **incorrect sink labels** or outdated packages; we cleaned where possible.
* TypeScript sources were converted to JS for consistency before MDG export.
* MDG schema variations exist across tools/versions; the training loader is robust to common CSV quirks (BOM/NULLs/mis-delimited rows).

---

## Cite / Acknowledge

If you use this dataset or training code, please link to:

* **SecBench.js** and **Vulcan Dataset** (original example sources)
* **GraphJS** (graph extraction)
* This repo (MDGNN dataset & training)

